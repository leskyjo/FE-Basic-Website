ONBOARDING_AUTH_PROFILE.md

Felon Entrepreneur — Auth & Profile Blueprint
(Aligned with No-Navigation Onboarding Tunnel)

This blueprint defines all behavior related to authentication and the user profile during the onboarding flow:

Login and signup UX and logic.

Auth + onboarding tunnel layout behavior (no global nav).

How and when the profiles row is created and updated.

How onboarding_step is used to route users correctly.

Security requirements around auth and profile data.

Email flows that are directly tied to auth (welcome, verification, password reset).

This document must be read alongside:

ONBOARDING_OVERVIEW.md (high-level story and phases)

ONBOARDING_NAV_LAYOUT.md (nav visibility and routing rules)

1. Scope and responsibilities

This blueprint covers:

Routes/screens in the auth + onboarding tunnel related to auth/profile:

/signup

/login

/forgot-password (if implemented)

Email verification confirmation screen (if email verification is enforced)

Profile creation and updating:

Creating a profiles row when a new account is created.

Updating profiles.onboarding_step as user progresses.

Keeping preferred_name, email, and zip_code in sync.

Auth state and redirects:

Where users are sent after login or signup, based on onboarding_step.

How returning users resume onboarding.

Security and privacy rules specific to auth and profile:

Supabase auth usage.

Row-Level Security (RLS) basics for profiles.

Input validation and brute-force protections at the auth layer.

Email operations related to auth:

Welcome/verification email.

Password reset.

Optional “new device/login” alerts (future).

This blueprint does not define the full schema for all tables or all email flows; the broader schemas and email patterns will live in ONBOARDING_DATA_SECURITY_EMAIL.md. Here we only include what is tightly connected to authentication and profile handling.

2. Layout and navigation rules for auth pages

These rules apply to:

/signup

/login

/forgot-password (if present)

Email verification confirmation page

Layout type: Auth + onboarding tunnel layout.

Key rule:
These screens must not show:

Bottom navigation bar (mobile).

Header navigation bar (desktop/tablet).

Hamburger menu.

They use a dedicated full-screen auth layout with:

FE logo centered at top (or top-left).

Simple, focused content area in the center (form + copy).

Small “Back to Home” text link (e.g., top-left or bottom).

Example layout structure (conceptual, not code):

Top: Logo + “Back to Home” link.

Middle: Auth card with title, description, form, error messages, and submit button.

Bottom: Helper links like “Already have an account? Log In”.

This layout visually matches the look and feel of the onboarding steps, so auth feels like the beginning of the same tunnel.

3. Signup (/signup) — Front-end behavior
3.1 Purpose

Create a new Supabase auth user.

Create a corresponding profiles row.

Immediately put the user into the onboarding tunnel (Name → Location → etc.).

3.2 Inputs on the signup form

The signup form must be simple and low-friction but still secure:

Required fields:

First name

Used initially as preferred_name.

Plain text, 1–50 characters, letters and simple punctuation only.

Email

Must be a valid email format.

Trimmed and lowercased before sending to backend (to avoid duplicates).

Password

Password policy:

Minimum length (e.g., 8–10 characters).

Should recommend a mix of letters, numbers, and symbols.

Password field should be masked.

Confirm password

Must match Password exactly before submission.

Terms & Privacy checkbox

The user must actively check a box acknowledging Terms & Policy.

Form cannot be submitted unless this is checked.

3.3 Validation and error handling

On the front-end:

Basic client-side validations:

Required fields not empty.

Email looks like an email.

Password and confirm match.

Terms checkbox is ticked.

On submit:

Disable the submit button and show a spinner or “Creating account…” text.

Call Supabase auth.signUp({ email, password, options }).

Possible errors that need clear user feedback:

Email already in use.

Password too weak (if provider returns that).

Network errors.

User-facing messages must be simple and non-technical.

3.4 Creating the profile row

After Supabase returns a successful sign-up:

The app must create or upsert a row in the profiles table with at least:

user_id = Supabase auth.user.id.

email = user’s email (normalized).

preferred_name = first name from signup form.

zip_code = null at this point.

onboarding_step = 0 (meaning: account created, onboarding not started).

created_at, updated_at timestamps (handled by DB defaults or explicit inserts).

Tier/trial fields set to default values (e.g., no paid tier yet, no trial started).

If email verification is required:

The Supabase signUp call may mark the user as unconfirmed until they click the email link.

We still create a profiles row, but any access to app routes remains blocked until email is confirmed.

The next screen is a “Check your email to verify” page.

If email verification is not required:

After profile row creation, move directly into /onboarding/name.

3.5 Post-signup redirect logic

After signup is complete:

If using email verification:

Show a “Check your email” page with:

Explanation of why verification is needed.

A button “Open email app” (mobile).

A “Resend verification email” button with rate limiting.

After a verified login:

The system checks profiles.onboarding_step:

If < 4 → route to the correct onboarding step.

If >= 4 → route to /dashboard.

If not using email verification:

Immediately after profile creation:

Redirect to /onboarding/name (start of the onboarding tunnel).

In both scenarios:

Navigation remains hidden; the user is still in the auth + onboarding layout.

4. Login (/login) — Front-end behavior
4.1 Purpose

Allow existing users to log into their account.

Based on their onboarding_step, either:

Resume onboarding in the tunnel, or

Enter the app layout (/dashboard) with navigation.

4.2 Inputs on the login form

Fields:

Email

Password

Supporting links:

“Forgot password?” → /forgot-password (if implemented).

“Don’t have an account? Join free” → /signup.

4.3 Validation and error handling

On submit:

Require both email and password.

Call Supabase auth.signInWithPassword({ email, password }).

Show loading state while awaiting response.

Error cases:

Invalid email/password combination:

Show a generic message: “Email or password is incorrect.”

Do not specify which one is wrong (for security).

Account not verified (if email verification is used):

Show a message: “Please verify your email to continue.”

Offer “Resend verification email” with rate limiting.

Network/technical errors:

“Something went wrong. Please try again in a moment.”

4.4 Post-login redirect logic

Once login succeeds and the user session is established:

Fetch the profiles row for auth.user.id.

Check profiles.onboarding_step.

Routing instructions:

If no profile row is found (should rarely happen):

Create one with defaults (similar to signup but with no first name yet).

Set onboarding_step = 0.

Redirect to /onboarding/name.

If profiles.onboarding_step is:

0 → /onboarding/name

1 → /onboarding/location

2 → /onboarding/bridge

3 → /onboarding/questions

4 or higher → /dashboard

Layout:

If step < 4 → still in auth + onboarding layout (no nav).

If step ≥ 4 → switch to app layout (nav visible).

5. Forgot Password (/forgot-password) — optional but recommended
5.1 Purpose

Let users reset their password securely without contacting support.

5.2 Front-end behavior

Screen content:

Title: “Reset your password”.

Description: “Enter the email you used to create your account.”

Single email input field.

Submit button: “Send reset link”.

On submit:

Validate email format.

Call Supabase auth.resetPasswordForEmail(email, { redirectTo: <URL> }).

Show success message: “If an account exists with that email, we’ve sent a reset link.”

Reset link behavior:

The redirectTo URL must be a route in the auth + onboarding layout (for example /reset-password) so navigation remains hidden while changing the password.

Supabase will manage the token; the /reset-password page will call auth.updateUser({ password: newPassword }).

5.3 Security and privacy considerations

Always show the same generic success message for unknown emails to avoid user enumeration.

Enforce password policy on the new password.

Rate limit reset requests per email/IP to prevent abuse.

6. Profile model — fields and behavior tied to onboarding

The profile is the central user metadata record. It must always be kept in sync with auth and onboarding.

6.1 Minimum required fields for profiles

At a minimum, the profiles table must contain:

user_id (UUID, primary key, foreign key to Supabase auth user).

email (text, normalized to lowercase).

preferred_name (text).

zip_code (text or small varchar).

onboarding_step (integer).

tier and/or subscription_status reference fields.

created_at (timestamp).

updated_at (timestamp).

Additional fields are allowed (for example, phone, avatar_url) but are not core to onboarding.

6.2 When profiles are created

Profiles must be created in all of these situations:

After a successful signup (normal path).

After a successful login if a profile row does not exist (recovery path).

After an OAuth or social login (if implemented in the future).

Creation rules:

If a row already exists for the user_id, never create a duplicate.

Use an upsert operation keyed on user_id.

6.3 Updating onboarding_step

This field is the single source of truth for where the user is in onboarding.

Updates:

After /onboarding/name step successfully submits:

onboarding_step = 1.

After /onboarding/location:

onboarding_step = 2.

After /onboarding/bridge and clicking “Start Questions”:

onboarding_step = 3.

After finishing the questionnaire and hitting “Generate My Life Plan”:

onboarding_step = 4.

The frontend must not manually set random values.
It should call a specific helper or API or direct Supabase update that sets explicit steps at the right checkpoints.

6.4 Keeping name and email in sync

preferred_name should be set initially from the first name on signup and then updated on /onboarding/name.

email should match the auth user email; if user changes email in profile settings later, both auth and profiles.email must be updated together.

7. Security requirements tied to auth and profiles
7.1 Row-Level Security (RLS) for profiles

RLS policies must ensure:

A normal, authenticated user can only:

SELECT his or her own profiles row.

UPDATE his or her own profiles row (only fields that are safe to change).

Policy logic (conceptual):

user_id = auth.uid() for all queries that aren’t admin/server-only.

No user should ever be able to:

See other users’ profiles.

Change someone else’s onboarding_step or tier.

Change tier fields directly (those must be updated via controlled billing flows).

7.2 Password and auth security

Given Supabase handles core password hashing and storage:

Do not handle raw passwords outside the browser environment.

Do not log passwords.

Use HTTPS in production to protect credentials in transit.

Consider rate limiting login attempts per IP/email combo (via middleware or WAF).

7.3 Sensitive data minimization

During auth and onboarding, profiles must:

Avoid storing highly sensitive identifiers (e.g., SSNs, driver’s license numbers, exact street addresses) in profiles.

Rely on ZIP and general data for plan calculations.

If additional sensitive data is ever required, it must go into separate tables with stricter controls (defined in data blueprint).

8. Email flows related to auth and profile

Auth-related email behavior for this blueprint:

8.1 Welcome / verification email

Trigger:

Successful signup.

Behavior:

If email verification is required:

Supabase sends an email with a special verification link.

The verification link routes to a URL in the auth + onboarding layout.

After verification:

User is considered verified.

On next login or direct access:

The app checks onboarding_step and routes to /onboarding/name (or the correct step).

Content (high level):

Short welcome message from Felon Entrepreneur.

Reassurance about privacy and how data will be used.

Clear button “Verify My Email”.

8.2 Resend verification email

Trigger:

User is on a “Check your email” screen or tries to log in but is blocked because unverified.

Behavior:

A “Resend verification email” button that:

Sends another email via Supabase.

Has built-in rate limiting per email address.

8.3 Password reset email

Trigger:

User submits /forgot-password form with an email.

Behavior:

Supabase sends password reset email with a secure token and link back to the app.

Link points to /reset-password in auth + onboarding layout (no nav).

Page renders a “New password” form and uses Supabase to update password.

8.4 Email event logging

Every auth-related email should create an entry in email_events (detailed in data/email blueprint):

For example:

event_type = 'welcome' | 'verify' | 'password_reset'

user_id

created_at

This is important for debugging and user support.

9. Implementation checklist for Codex / builder

When converting this blueprint into implementation tasks, the builder should:

Create Auth + Onboarding Layout:

Full-screen layout without bottom nav or header nav.

Shared by /signup, /login, /forgot-password, /reset-password, /onboarding/*.

Implement /signup:

Fields: first name, email, password, confirm password, Terms checkbox.

Client-side validation.

Call Supabase auth.signUp.

Create or upsert profiles row with default onboarding_step = 0.

Redirect based on email verification setting.

Implement /login:

Fields: email, password.

Login with Supabase auth.

Fetch profiles row on success.

Redirect based on onboarding_step:

< 4 → correct /onboarding/* route.

≥ 4 → /dashboard.

Implement /forgot-password + /reset-password (if enabled):

Email-based reset form.

Reset link points into auth + onboarding layout.

Update password and then route user to login.

Implement profiles handling:

Automatic creation on signup.

Creation fallback on login if missing.

onboarding_step updates at each onboarding stage.

Enforce security:

RLS on profiles so users only see and update their own row.

Proper HTTPS and no password logging.

Optionally implement rate limiting.

Tie in email flows:

Support verification email flows.

Support password reset emails.

Log events in email_events.